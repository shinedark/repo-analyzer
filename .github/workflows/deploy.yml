name: ðŸš€ Deploy GitHub Pattern Analyzer

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Run Tests
      run: npm test -- --coverage --watchAll=false

    - name: ðŸ—ï¸ Build Application
      run: npm run build

    - name: ðŸ”§ Configure SPA for GitHub Pages
      run: |
        # Copy index.html to 404.html for SPA routing
        cp build/index.html build/404.html
        echo "âœ… SPA routing configured"

    - name: âš¡ Optimize Build (Human-Readable)
      run: |
        node build-optimizer.js --strategy max-aggression
        echo "âœ… Human-readable optimization completed"

    - name: ðŸš€ Computer Optimization (Production)
      run: |
        node build-optimizer.js --computer-optimized --strategy max-aggression
        echo "âœ… Computer optimization completed"
        
    - name: ðŸ“Š Display Optimization Results
      run: |
        if [ -f "optimized-build/optimization-manifest.json" ]; then
          echo "ðŸ“ˆ Optimization Results:"
          cat optimized-build/optimization-manifest.json | jq '.averageReduction, .totalOriginalSize, .totalOptimizedSize'
        fi

    - name: ðŸ”§ Setup Debug Server (Background)
      run: |
        node debug-server.js 3001 &
        sleep 2
        echo "ðŸ”§ Debug server started at http://localhost:3001"

    - name: ðŸ§ª Test Error Translation
      run: |
        node error-translator.js translate "x3 is not defined"
        echo "âœ… Error translation system working"

    - name: ðŸ—ï¸ Setup Pages
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      id: pages
      uses: actions/configure-pages@v4
      with:
        static_site_generator: react

    - name: ðŸ“¦ Upload Pages Artifact
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./build

    - name: ðŸ“¤ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: actions/deploy-pages@v4
      with:
        pages: ${{ steps.pages.outputs.page_id }}

    - name: ðŸŽ‰ Deployment Success
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸŒ Live at: https://shinedark.github.io/repo-analyzer"
        echo "ðŸ“Š Optimization achieved: Check manifest for details"
        echo "ðŸ”§ Debug interface available in development"

    - name: ðŸ“‹ Create Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Node Version | 18 |" >> $GITHUB_STEP_SUMMARY
        echo "| Optimization | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
        echo "| Debug Tools | âœ… Available |" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "optimized-build/optimization-manifest.json" ]; then
          REDUCTION=$(cat optimized-build/optimization-manifest.json | jq -r '.averageReduction')
          echo "| Size Reduction | ${REDUCTION}% |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ [Live Application](https://shinedark.github.io/repo-analyzer)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š [Repository](https://github.com/shinedark/repo-analyzer)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ [Debug Tools](http://localhost:3001) (development only)" >> $GITHUB_STEP_SUMMARY

  performance-audit:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Verify Lighthouse Config
      run: |
        echo "Checking for Lighthouse config file..."
        ls -la .github/lighthouse/
        if [ -f ".github/lighthouse/config.json" ]; then
          echo "âœ… Lighthouse config found"
          cat .github/lighthouse/config.json
        else
          echo "âŒ Lighthouse config not found"
          exit 1
        fi

    - name: ðŸ” Lighthouse Performance Audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://shinedark.github.io/repo-analyzer
        configPath: '.github/lighthouse/config.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

    - name: ðŸ“Š Performance Report
      run: |
        echo "## ðŸ” Performance Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "Lighthouse audit completed for the deployed application" >> $GITHUB_STEP_SUMMARY
        echo "Check the artifacts for detailed performance metrics" >> $GITHUB_STEP_SUMMARY
